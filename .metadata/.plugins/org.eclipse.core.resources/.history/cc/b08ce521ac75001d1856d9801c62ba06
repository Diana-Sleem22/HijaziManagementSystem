package application;

import java.awt.event.InputMethodEvent;
import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.ResourceBundle;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TablePosition;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;

public class companyController implements Initializable {
	CompanyModel selectedCompany;
	  @FXML
	    private Button addCompanyBtn;

	    @FXML
	    private TextField companyNameInput;

	    @FXML
	    private TextField companyPhoneInput;
	    @FXML
	    private TableColumn<CompanyModel, String> companyNameColumn;
	    @FXML
	    private TableColumn<CompanyModel,String> companyPhoneColumn;
	    @FXML
	    private TableView<CompanyModel>companyTable;
	    private ObservableList<CompanyModel> data =  FXCollections.observableArrayList();	
	    @FXML
	    private TextField searchtxt;

	    @FXML
	    void registerCompany(ActionEvent event) throws IOException, ParseException {
			CompanyModel cm = new CompanyModel(companyNameInput.getText(), companyPhoneInput.getText());
	    	System.out.println(cm.toString());
	     CommonFunctions.sendHTTPRequest("http://localhost:8080/registerCompany", "POST","", cm.toString());
	    	data.add( new CompanyModel(companyNameInput.getText().toString(), companyPhoneInput.getText().toString()));
			companyTable.setItems(data);             
			companyNameInput.setText("");
			companyPhoneInput.setText("");
	    }
	    @FXML
	    void updateCompany(ActionEvent event) throws IOException, ParseException {
	    	CompanyModel cm = new CompanyModel(companyNameInput.getText(),companyPhoneInput.getText() ,Integer.parseInt(selectedCompany.getId()+""));
	    	System.out.println(cm);
			 CommonFunctions.sendHTTPRequest("http://localhost:8080/updateCompany", "PUT", "", cm.toString());
			int index = data.indexOf(selectedCompany);
			data.remove(index);
			data.add(index, cm);
			companyTable.setItems(data);             

		
	    }
	    @FXML
	    void searchCompany(javafx.scene.input.InputMethodEvent event) {
	    	JSONObject responseAPI = CommonFunctions.sendHTTPRequest("http://localhost:8080/searchCompanies", "GET", searchtxt.getText(), "");

	        
	        JSONArray arr = (JSONArray) responseAPI.get("data");



	        for (int i = 0; i < arr.size(); i++) {
	        	  JSONObject new_obj = (JSONObject) arr.get(i);


				data.add(new CompanyModel(new_obj.get("name").toString(), new_obj.get("phone").toString(), Integer.parseInt(new_obj.get("id").toString())));
			}
			System.out.print(data);
			
			companyTable.setItems(data);             
			
	    }
	    @FXML
	    void deleteCompany(ActionEvent event) throws IOException, ParseException {
	    	CompanyModel cm = new CompanyModel(companyNameInput.getText(),companyPhoneInput.getText() ,Integer.parseInt(selectedCompany.getId()+""));
	    	System.out.println(cm);
			 CommonFunctions.sendHTTPRequest("http://localhost:8080/deleteCompany", "DELETE",selectedCompany.getId()+"" , cm.toString());
			int index = data.indexOf(selectedCompany);
			data.remove(index);
			
			companyTable.setItems(data);             

	    }

		@Override
		public void initialize(URL arg0, ResourceBundle arg1) {
			data.clear();
			companyNameColumn.setCellValueFactory(new PropertyValueFactory("name"));
			companyPhoneColumn.setCellValueFactory(new PropertyValueFactory("phone"));

			try {
				JSONObject responseAPI = CommonFunctions.sendHTTPRequest("http://localhost:8080/getAllCompanies", "GET", "", "");

		        
		        JSONArray arr = (JSONArray) responseAPI.get("data");



		        for (int i = 0; i < arr.size(); i++) {
		        	  JSONObject new_obj = (JSONObject) arr.get(i);


					data.add(new CompanyModel(new_obj.get("name").toString(), new_obj.get("phone").toString(), Integer.parseInt(new_obj.get("id").toString())));
				}
				System.out.print(data);
				
				companyTable.setItems(data);             
				companyTable.setOnMouseClicked((MouseEvent event) -> {
				    if (event.getClickCount() > 1) {
				        onEdit();
				    }
				});
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			} catch (ParseException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
	        
		
	}
		
		public void onEdit() {
		    // check the table's selected item and get selected item
		    if (companyTable.getSelectionModel().getSelectedItem() != null) {
		    	
		        selectedCompany = companyTable.getSelectionModel().getSelectedItem();
		       companyNameInput.setText(selectedCompany.getName());
		       companyPhoneInput.setText(selectedCompany.getPhone());
		    }
		}
	
}
